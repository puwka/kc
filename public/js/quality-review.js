let reviewId=null;let currentUser=null;document.addEventListener('DOMContentLoaded',()=>{init()});async function init(){try{const params=new URLSearchParams(location.search);reviewId=params.get('id');if(!reviewId){alert('Не указан id проверки');location.href='/quality.html';return}const token=localStorage.getItem('token');if(!token){location.href='/login.html';return}await loadMe(token);await loadReview();bindEvents()}catch(e){notify('Ошибка загрузки страницы','error')}}async function loadMe(token){const resp=await fetch('/api/auth/me',{headers:{'Authorization':`Bearer ${token}`}});const data=await resp.json();currentUser=data.user;document.getElementById('userName').textContent=currentUser.name;document.getElementById('userRole').textContent=currentUser.role;if(currentUser.role!=='quality'&&currentUser.role!=='admin'){location.href='/';}}async function loadReview(){showLoader();try{const resp=await fetch(`/api/quality/reviews?status=pending`,{headers:{'Authorization':`Bearer ${localStorage.getItem('token')}`}});const all=await resp.json();const review=all.find(r=>r.id===reviewId);if(!review){notify('Заявка не найдена или уже обработана','warning');location.href='/quality.html';return}renderLead(review)}finally{hideLoader()}}function renderLead(r){const lead=r.leads||{};const details=document.getElementById('leadDetails');details.innerHTML=`<div class="detail-item"><div class="detail-label">Имя:</div><div class="detail-value">${lead.name||'-'}</div></div><div class="detail-item phone"><div class="detail-label">Телефон:</div><div class="detail-value">${lead.phone||'-'}</div></div><div class="detail-item"><div class="detail-label">ID лида:</div><div class="detail-value">${r.lead_id}</div></div>`;loadScriptForLead(lead);loadAudioForLead(lead)}function loadScriptForLead(lead){const box=document.getElementById('scriptContent');box.innerHTML=`<p>Скрипт подбирается по типу проекта. Здесь отобразится текст, который использовал оператор.</p>`}function loadAudioForLead(lead){const src=document.getElementById('audioSource');const audio=document.getElementById('callAudio');src.src=lead.record_url||'';if(!src.src){audio.style.display='none'}audio.load()}function bindEvents(){document.getElementById('logoutBtn').addEventListener('click',()=>{localStorage.clear();location.href='/login.html'});document.getElementById('approveBtn').addEventListener('click',()=>saveDecision('approve'));document.getElementById('rejectBtn').addEventListener('click',()=>saveDecision('reject'))}async function saveDecision(action){try{showLoader();const comment=document.getElementById('commentText').value;const url=action==='approve'?`/api/quality/reviews/${reviewId}/approve`:`/api/quality/reviews/${reviewId}/reject`;const resp=await fetch(url,{method:'POST',headers:{'Authorization':`Bearer ${localStorage.getItem('token')}`,'Content-Type':'application/json'},body:JSON.stringify({comment})});if(!resp.ok){throw new Error('Ошибка сохранения решения')}notify('Решение сохранено','success');setTimeout(()=>location.href='/quality.html',600)}catch(e){notify(e.message,'error')}finally{hideLoader()}}function showLoader(){const o=document.getElementById('loaderOverlay');o.style.display='flex';setTimeout(()=>o.classList.add('show'),10)}function hideLoader(){const o=document.getElementById('loaderOverlay');o.classList.remove('show');setTimeout(()=>o.style.display='none',300)}function notify(message,type='info'){const box=document.getElementById('notifications');const el=document.createElement('div');el.className=`notification ${type}`;el.textContent=message;box.appendChild(el);setTimeout(()=>el.remove(),3000)}
